- [上传文件攻击](#上传文件攻击)
  - [攻击条件](#攻击条件)
  - [防御](#防御)

# 上传文件攻击

网站给用户提供了上传文件（如：图片）的功能，而用户有可能上传的是恶意脚本。恶意脚本可以直接在服务端执行，也可以当网站加载这个文件时在浏览器里执行。这样就造成了上传文件攻击。

## 攻击条件

一般来说，要想成功完成上传文件攻击，需要具备以下条件：

- 上传的文件能够被 Web 容器解释执行
- 用户能够在 Web 上访问这个文件

另外，上传的文件没有被处理（比如：用户上传的文件被安全检查、格式化、压缩等改变了内容）也决定了攻击是否能成功。

## 防御

- 限制上传后缀

  对上传文件后缀名进行限制，一定要使用白名单，黑名单的方式很容易被绕过。

  > 这种方法只能简单的限制一下用户通过浏览器上传的文件。
  > 攻击者可以通过其他方法发送网络请求来绕过这个防御。

- 检查 HTTP 请求头

  > 通过检查上传文件 HTTP 请求头 `Content-Type`，判断是不是图片类型，例如：`image/png` `image/jpeg`。
  > 这种方法可以通过篡改 HTTP 请求头来绕过

- 文件内容检查

  > 由于每种类型的文件都会有一些特征性的文件头，所以可以通过这一点来检查上传文件。
  > 这种方法可以被攻击者通过伪造特征性的文件头进行绕过。

- 改写文件名和路径

  > 服务器接收到用户上传的文件后，将文件名改写为 hash 加密的字符串，并修改文件的路径。

- 单独设置文件服务器的域名

  > 由于同源策略的限制，当文件服务器和网站服务器在不同的域名下时，就可以避免用户上传的恶意脚本对网站进行攻击。

- 权限控制（可写权限和可执行权限互斥）

  > 对每个文件进行权限管理。可读的文件和可执行的文件分开放置，这样浏览器端就不能既读文件又执行文件了。
  > 这种方法是每个网站系统都应该做的基本安全措施。
